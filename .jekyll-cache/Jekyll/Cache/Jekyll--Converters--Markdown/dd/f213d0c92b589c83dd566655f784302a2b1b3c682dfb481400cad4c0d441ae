I"Ï<p>A few months ago, we upgraded one of our backend services from rails version 5.2 to 7.0. This blog outlines the path to upgrading the service, the challenges we came across, and the learnings on the way.</p>

<h3 id="upgrading-the-dependencies">Upgrading the dependencies</h3>

<p>Initial research revealed that the service we needed to upgrade was dependent on an internal gem. This gem used <code class="language-plaintext highlighter-rouge">ActiveRecord</code>, <code class="language-plaintext highlighter-rouge">ActiveSupport</code>, and <code class="language-plaintext highlighter-rouge">ActiveModel</code>, and was used by a few other services.</p>

<p>The first step was to upgrade this gem to support versions 5.2 to 7.0, making it backward compatible with other services. This was done incrementally. First, we added support for version 6.0, then 6.1, and finally 7.0.</p>

<p>Once this was accomplished, the actual work of upgrading our service to Rails 7 started.</p>

<h3 id="upgrading-the-service">Upgrading the Service</h3>

<p>We decided to do this incrementally as well. Upgrade the service from rails version 5.2 to 6.0 to 6.1 and finally to 7.0. Testing and deploying after every upgrade.</p>

<h4 id="upgrade-service-to-rails-version-60">Upgrade service to rails version 6.0</h4>

<p>The first step in this upgrade was to update the gems and dependencies supporting rails version 6.0. Great test coverage was an ally here, helping us make the changes confidently without the fear of breaking.</p>

<h4 id="failures-encountered">Failures encountered</h4>

<ul>
  <li>Failure caused due to the change in the behavior of the <em>where</em> clause.<br />
<strong>Cause</strong>: Previous versions returned <code class="language-plaintext highlighter-rouge">ActiveRecord::RangeError</code> for the where clause after querying DB if the value was out of range. This behavior changed in rails version 6.0, so as to not run the query against out-of-range numbers and return an empty array instead.<br />
 <strong>Resolution</strong>: The test cases needed to change, in order to match the new expected result. No changes were required to the code.</li>
</ul>

<p>More details on the <a href="https://github.com/rails/rails/issues/38309">Rails 6 - RangeError not raised while interacting with ActiveRecord</a></p>

<p>Once this change was complete, it was deployed to the staging environment and tested. It was then deployed to production.</p>

<h4 id="upgrade-the-ruby-version-to-270">Upgrade the ruby version to 2.7.0</h4>

<p>Since Rails 6.1 requires ruby versions 2.5 and up, and Rails 7 requires ruby version 2.7 and up, the service was upgraded to ruby version 2.7 from version 2.5.</p>

<h4 id="upgrade-service-to-rails-version-70">Upgrade service to rails version 7.0</h4>

<p>Once the service was upgraded and deployed to production with rails 6.1, we started upgrading the service to 7.0. and this was where we encountered major failures.</p>

<h4 id="failures-encountered-1">Failures encountered</h4>

<ol>
  <li>
    <p><strong>Failure:</strong> Unable to reload models/ReadOnly in initializers.<br />
<strong>Resolution:</strong> Added <code class="language-plaintext highlighter-rouge">ActiveSupport::Reloader</code> to allow reloading the file.</p>
  </li>
  <li>
    <p><strong>Failure:</strong> Files under the <em>Concerns namespace</em> were not loading.<br />
<strong>Cause:</strong> Applications that were running in <em>classic mode</em> needed to use <em>Zeitwerk mode</em> from Rails 7 onwards<strong>.</strong> Zeitwerk gem usage for rails 7.x changed how we define concerns.<br />
<strong>Resolution:</strong> Removal of the Concerns module wrapping from file names fixed this issue.</p>
  </li>
  <li>
    <p><strong>Failure</strong>: Unable to resolve file names such as Author_ID<br />
<strong>Cause:</strong> AuthorID was being resolved to author_i_d instead of author_id because of <em>Zeitwerk mode</em>.<br />
<strong>Resolution:</strong> Adding inflections resolved the naming issues.<br /></p>
  </li>
</ol>

<h4 id="resolving-deprecation-warnings">Resolving Deprecation Warnings</h4>

<ol>
  <li>
    <p><strong>Warning message:</strong> <code class="language-plaintext highlighter-rouge">Top level::CompositeIO is deprecated, require 'multipart/post' and use Multipart::Post::CompositeReadIO instead!</code><br />
<strong>Cause:</strong> Usage of an older version of the Faraday gem<br />
<strong>Resolution:</strong> Updating faraday gem to version 1.x resolved this issue.</p>
  </li>
  <li>
    <p><strong>Warning message:</strong> Using legacy connection handling is deprecated. Please set <strong>legacy_connection_handling</strong> to <strong>false</strong> in your application<br />
<strong>Cause:</strong> Update in connection management for rails &gt; 6.1.<br />
<strong>Resolution:</strong> Marking <code class="language-plaintext highlighter-rouge">config.active_record.legacy_connection_handling = false</code> resolved this issue. <br />
Find more information on this <a href="https://guides.rubyonrails.org/active_record_multiple_databases.html#migrate-to-the-new-connection-handling">here</a></p>
  </li>
</ol>

<h4 id="failing-ci-build">Failing CI build</h4>

<p><strong>Failure:</strong> <code class="language-plaintext highlighter-rouge">rake aborted! Don't know how to build task 'db:structure:load' (See the list of available tasks with rake --tasks). Did you mean?Â  db:test:load</code> <br />
<strong>Cause:</strong> <code class="language-plaintext highlighter-rouge">db:structure:load</code> deprecated in favor of <code class="language-plaintext highlighter-rouge">db:schema:load</code>. Structures and schemas both will be handled by<code class="language-plaintext highlighter-rouge"> db:schema:load</code> <br />
<strong>Resolution:</strong> Updating commands to use <code class="language-plaintext highlighter-rouge">db:schema:load</code> in CI and locally, resolved this issue.<br />
Find more information on this <a href="https://blog.saeloun.com/2020/09/30/rails-deprecates-db-structure-commands.html">here</a></p>
:ET